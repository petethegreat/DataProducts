---
title: "IMDB movie ratings by genre"
author: Peter Thompson
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document
---
## Introduction

some plotly plots of imdb data, downloaded from [http://www.imdb.com/interfaces](http://www.imdb.com/interfaces)

## load data
interested in movie ratings, year, and genres. dealing with genres will be tricky, as a single movie may belong to multiple genres. Data also comes from multiple files, so will need to identify things by title and year. dplyr and tidyr (melt/cast) might be handy. Thinking a logical for each genre (is in/ not in). 

scatter plot ratings by year, faceted by genre
scatter plot ratings by year, coloured by genre
line plot mean rating per year (with quantiles) per genre (are horror movies improving?/are romances getting worst)
How many movies per genre are produced each year?

Might need to tweak the read.csv, or use read.table instead. There are a bunch of lines that should be omitted in one of the files. Check whitespace, columns might be tabbed or fixed width

```{r libraries,warning=FALSE,message=FALSE}
library(dplyr)
library(plotly)
```


```{r genres,cache=TRUE}
lines<-readLines('movies/genres.list')
lines<-lines[384:length(lines)]

# remove entries containing curly braces {} - often these are duplicates or movies that were suspended during/before production
# setlocale is needed to deal with some non-english characters
Sys.setlocale('LC_ALL','C') 
badlines<-grepl('\\{.*\\}',lines)
lines<-lines[!badlines]

#pull out the titles:
titles<-gsub('"([^"]+)".*','\\1',lines)
# years<-gsub('^.*\\(([0-9]+)\\).*','\\1',lines)
years<-gsub('^.*\\((.+)\\).*','\\1',lines)
years2<-gsub('([0-9]{4,4})/?[A-Z]*','\\1',years)
genres<-gsub('^.*?[ \t]+([A-Za-z-]+)$','\\1',lines)
# get a warning here because the coercion of year to numeric introduces some NAs
# this is ok (good), as there are a lot of '????' type values for year, in which case NA is appropriate

# We could use tidyr to gather this, creating a factor for each genre type.  
# don't neccasrily need to, right now data is in "long" format

genredf<-data.frame(title=titles,year=as.integer(years2),genre=as.factor(genres))
```
It might also be interesting to look into ratings information, but the formatting of the ratings.list file makes it difficult to deal with (in R at least).

Instead, will just look at the top 20 genres (i.e., those containing the most movies) over all time

```{r top20,cache=TRUE}
top20<-sort(table(genredf$genre),decreasing=TRUE)[1:20]
top20
t20list<-names(top20)
slimmed<- genredf %>% filter(genre %in% t20list)
```

## Plotly Plots

Bar chart showing the top 20 movie genres

```{r barchart,cache=TRUE,dependson=top20,fig.width=7,fig.height=7,dpi=108,warning=FALSE}
# bar chart
plot_ly(x=top20,y=names(top20),type='bar',orientation='h',color=~top20)

```

Scatter plot showing number of movies produced each year, by genre.

```{r plotstuff,dependson='top20',fig.width=7,fig.height=7,dpi=108,warning=FALSE}
# plot genres by year
moose2<-slimmed %>% group_by(year,genre) %>% summarize(count=n()) %>% arrange(genre,year)
# head(moose2)
plot_ly(data=moose2,
    x=~year,
    y=~count,
    type='scatter',
    mode='markers+lines',
    color=~genre,
    line=list(width=1)
    ) %>% 
    layout(
        xaxis=list(title='year of movie',range=c(1900,2020)),
        yaxis=list(type='log'))
```

Not sure why the lines (`mode='markers+lines'`) aren't showing up. Genres tend to follow the same trend. During the 80's and 90's there were more Action movies produced than Romances (beacuse action movies were [awesome](http://www.imdb.com/title/tt0103064/) [then](http://www.imdb.com/title/tt0112864/).



